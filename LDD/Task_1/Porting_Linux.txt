ğŸš€ Raspberry Pi 5 â€“ Custom Boot (Kernel + DTB + Modules + RootFS)
ğŸ§© Task-1: Custom Boot for Raspberry Pi 5

This task demonstrates a manual custom boot process for Raspberry Pi 5, where the Linux system is built and assembled from scratch instead of using a prebuilt OS image.

This approach is widely used in:

ğŸ§  Embedded Linux

ğŸ§© BSP development

ğŸ”§ Kernel & LDD work

ğŸ¯ Objective

To boot Raspberry Pi 5 using a custom Linux setup consisting of:

ğŸ§  Custom-compiled Linux Kernel

ğŸŒ³ Device Tree Blob (DTB)

ğŸ”Œ Kernel Modules

ğŸ—‚ï¸ Ubuntu ARM64 Root File System

with full control over the boot process.

ğŸ’½ SD Card Layout

The SD card is manually partitioned into two partitions:

ğŸŸ¢ 1ï¸âƒ£ BOOT Partition (FAT32)

ğŸ“ Purpose: Used by Raspberry Pi firmware to load the kernel and boot configuration.

Contains:

ğŸ§  kernel_2712.img â†’ Raspberry Pi 5 kernel image

ğŸŒ³ bcm2712-rpi-5-b.dtb â†’ Device Tree for BCM2712 (Pi 5)

ğŸ§© overlays/ â†’ Optional DT overlays

âš™ï¸ config.txt â†’ Boot configuration

ğŸ§µ cmdline.txt â†’ Kernel boot arguments

âš¡ Firmware files:

start*.elf

fixup*.dat

ğŸ”µ 2ï¸âƒ£ ROOTFS Partition (ext4)

ğŸ“ Purpose: Linux root filesystem (userspace).

Contains:

ğŸ—‚ï¸ Ubuntu ARM64 root filesystem (minimal / full)

ğŸ”Œ Kernel modules:

/lib/modules/<kernel-version>/

ğŸ› ï¸ Step-by-Step Custom Boot Process
âœ… Step 0ï¸âƒ£: Install Required Packages (Ubuntu Host)

ğŸ–¥ï¸ Purpose:
Prepare the Ubuntu PC for:

ğŸ§© Cross-compiling

ğŸ” ARM chroot

ğŸ’½ SD card partitioning

sudo apt update
sudo apt install -y git bc bison flex libssl-dev make \
  libc6-dev libncurses5-dev libelf-dev dwarves \
  crossbuild-essential-arm64 \
  qemu-user-static debootstrap rsync \
  dosfstools parted kmod

âœ… Step 1ï¸âƒ£: Get Raspberry Pi Linux Kernel Source

ğŸ“¥ Purpose:
Use the vendor kernel which includes:

BCM2712 SoC support

Raspberry Pi 5 DTBs

mkdir -p ~/rpi5_custom && cd ~/rpi5_custom
git clone --depth=1 https://github.com/raspberrypi/linux.git
cd linux

âœ… Step 2ï¸âƒ£: Configure Kernel for Raspberry Pi 5

ğŸŒ Target Architecture: ARM64
ğŸ§  SoC: BCM2712

export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-

make bcm2712_defconfig


ğŸ› ï¸ Optional customization:

make menuconfig


ğŸ“Œ This generates a .config file tailored for Raspberry Pi 5.

âœ… Step 3ï¸âƒ£: Compile Kernel, Modules & DTBs

ğŸ”¨ Build process (takes time):

make -j$(nproc) Image modules dtbs


ğŸ“¦ Important build outputs:

ğŸ§  Kernel Image

arch/arm64/boot/Image


ğŸŒ³ Device Tree Blob

arch/arm64/boot/dts/broadcom/bcm2712-rpi-5-b.dtb

âœ… Step 4ï¸âƒ£: Prepare SD Card

ğŸ’½ Insert SD card and identify device:

lsblk


Example device: /dev/sdb

ğŸ§± Partition SD card:

sudo parted /dev/sdb --script mklabel msdos
sudo parted /dev/sdb --script mkpart primary fat32 1MiB 513MiB
sudo parted /dev/sdb --script mkpart primary ext4 513MiB 100%
sudo parted /dev/sdb --script set 1 boot on


ğŸ§ª Format partitions:

sudo mkfs.vfat -F32 /dev/sdb1
sudo mkfs.ext4 /dev/sdb2


ğŸ“‚ Mount partitions:

mkdir -p ~/mnt/rpi5_boot ~/mnt/rpi5_root
sudo mount /dev/sdb1 ~/mnt/rpi5_boot
sudo mount /dev/sdb2 ~/mnt/rpi5_root

âœ… Step 5ï¸âƒ£: Install Ubuntu RootFS (ARM64)

ğŸ—‚ï¸ Create minimal Ubuntu root filesystem:

sudo debootstrap --arch=arm64 noble ~/mnt/rpi5_root http://ports.ubuntu.com/


ğŸ” Enable ARM binaries on x86 host:

sudo cp /usr/bin/qemu-aarch64-static ~/mnt/rpi5_root/usr/bin/


ğŸ”— Mount runtime filesystems:

sudo mount --bind /dev ~/mnt/rpi5_root/dev
sudo mount --bind /proc ~/mnt/rpi5_root/proc
sudo mount --bind /sys ~/mnt/rpi5_root/sys


ğŸ  Enter root filesystem:

sudo chroot ~/mnt/rpi5_root /bin/bash


Inside chroot:

apt update
apt install -y sudo ssh net-tools network-manager systemd vim
passwd root

useradd -m -s /bin/bash komal
passwd komal
usermod -aG sudo komal
exit


ğŸ”“ Unmount:

sudo umount ~/mnt/rpi5_root/dev
sudo umount ~/mnt/rpi5_root/proc
sudo umount ~/mnt/rpi5_root/sys

âœ… Step 6ï¸âƒ£: Install Kernel Modules into RootFS

ğŸ”Œ From kernel source directory:

cd ~/rpi5_custom/linux
sudo make modules_install INSTALL_MOD_PATH=~/mnt/rpi5_root


ğŸ“ Modules installed at:

~/mnt/rpi5_root/lib/modules/<kernel-version>/

âœ… Step 7ï¸âƒ£: Copy Kernel & DTB to BOOT Partition

ğŸ§  Copy kernel (Pi 5 naming):

sudo cp arch/arm64/boot/Image ~/mnt/rpi5_boot/kernel_2712.img


ğŸŒ³ Copy DTB:

sudo mkdir -p ~/mnt/rpi5_boot/broadcom
sudo cp arch/arm64/boot/dts/broadcom/bcm2712-rpi-5-b.dtb \
~/mnt/rpi5_boot/broadcom/


ğŸ§© Optional overlays:

sudo cp -r arch/arm64/boot/dts/overlays ~/mnt/rpi5_boot/

âœ… Step 8ï¸âƒ£: Add Raspberry Pi Firmware Files âš¡

ğŸ“Œ Required for Pi boot firmware stage.

cd ~/rpi5_custom
git clone --depth=1 https://github.com/raspberrypi/firmware.git

sudo cp firmware/boot/*.elf ~/mnt/rpi5_boot/
sudo cp firmware/boot/*.dat ~/mnt/rpi5_boot/
sudo cp firmware/boot/*.bin ~/mnt/rpi5_boot/

âœ… Step 9ï¸âƒ£: Create config.txt

âš™ï¸ Boot configuration:

arm_64bit=1
kernel=kernel_2712.img
device_tree=broadcom/bcm2712-rpi-5-b.dtb

enable_uart=1
dtoverlay=disable-bt
disable_splash=1
boot_delay=1

âœ… Step ğŸ”Ÿ: Create cmdline.txt

ğŸ§µ Kernel boot arguments (single line only):

console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 fsck.repair=yes rootwait rw

âœ… Step 1ï¸âƒ£1ï¸âƒ£: Configure fstab in RootFS
/dev/mmcblk0p2  /      ext4  defaults,noatime  0  1
/dev/mmcblk0p1  /boot  vfat  defaults          0  2


Create mount point:

sudo mkdir -p ~/mnt/rpi5_root/boot

âœ… Step 1ï¸âƒ£2ï¸âƒ£: Unmount & Boot ğŸš€
sync
sudo umount ~/mnt/rpi5_boot
sudo umount ~/mnt/rpi5_root


ğŸ‘‰ Insert SD card into Raspberry Pi 5
ğŸ‘‰ Power ON âš¡

ğŸ‰ Custom Linux boots successfully!

ğŸ§  Summary

âœ… Full manual Custom Boot achieved
âœ… Complete control over:

Kernel

DTB

Modules

RootFS

ğŸ¯ Ideal for:

Linux Device Drivers (LDD)

Kernel development

BSP & Embedded Linux learning


